<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ë¶„ë¦¬ ë„êµ¬</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f9fc; color: #333; position: relative; }
    h1 { margin-bottom: 10px; font-size: 1.5em; color: #2c3e50; }
    #instructions {
      position: absolute; top: 20px; right: 20px; width: 260px; max-height: 180px;
      overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px;
      font-size: 0.85em; color: #555; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 4px; line-height: 1.4;
    }
    #instructions strong { display: block; margin-bottom: 8px; }
    #instructions ol { padding-left: 20px; margin: 0; }
    #instructions li { margin-bottom: 4px; }
    #controls { margin-top: 80px; margin-bottom: 15px; }
    #controls > * { margin-right: 10px; vertical-align: middle; }
    #controls input[type="file"], #controls select, #controls input[type="text"], #controls button {
      height: 36px; line-height: 36px; padding: 0 12px; font-size: 1em; border-radius: 4px;
      background: #fff; border: 1px solid #ccc; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
      vertical-align: middle;
    }
    #controls input[type="file"] { border: none; cursor: pointer; }
    #controls input[type="file"]::-webkit-file-upload-button {
      border: none; line-height: 36px; padding: 0 12px; font: inherit; cursor: pointer;
    }
    #controls select { width: 140px; }
    #controls input[type="text"] { width: 200px; }
    #controls button { background: #3498db; border-color: #2980b9; color: #fff; cursor: pointer; }
    #controls button:disabled { background: #95a5a6; border-color: #7f8c8d; cursor: not-allowed; }
    #tableContainer { overflow-x: auto; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #ecf0f1; position: sticky; top: 0; z-index: 1; color: #2c3e50; }
    tr:nth-child(even) { background: #fafafa; }
    tr:hover { background: #e1f5fe; }
    .col-add-name { white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis; }
    #loadingOverlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5); color: #fff; font-size: 1.5em;
      align-items: center; justify-content: center; z-index: 9999;
    }
  </style>
</head>
<body>
  <h1>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ë¶„ë¦¬ ë„êµ¬</h1>

  <div id="instructions">
    <strong>ì‚¬ìš© ë°©ë²•</strong>
    <ol>
      <li>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ì„¼í„° â†’ ìƒí’ˆ ì¡°íšŒ/ìˆ˜ì •</li>
      <li>íŒë§¤ìƒíƒœ : íŒë§¤ì¤‘, í’ˆì ˆ â”‚ ê¸°ê°„ : ì „ì²´</li>
      <li>ê²€ìƒ‰ í´ë¦­ â†’ 1000ê°œì”© ì„ íƒ</li>
      <li>ìˆ˜ì •ì–‘ì‹ ë‹¤ìš´ë¡œë“œ â†’ ì´ í˜ì´ì§€ì—ì„œ ì—…ë¡œë“œ</li>
    </ol>
  </div>

  <div id="controls">
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <button id="resetButton">ì´ˆê¸°í™”</button>
    <select id="filter">
      <option value="all">ì „ì²´ë³´ê¸°</option>
      <option value="inStock">ì¬ê³ ìˆìŒ</option>
      <option value="soldOut">í’ˆì ˆë³´ê¸°</option>
    </select>
    <input type="text" id="search" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
    <button id="downloadButton" disabled>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div id="tableContainer"></div>
  <div id="loadingOverlay">ë³€í™˜ì¤‘ì…ë‹ˆë‹¤... * ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” *</div>

  <script>
    let originalData = [], transformedData = [];
    let metaRow1 = [], metaRow3 = [];
    let axisNames = ['ì˜µì…˜1', 'ì˜µì…˜2', 'ì˜µì…˜3'];
    let headersOrder = [];
    let originalFileName = '';
    const fileInput = document.getElementById('fileInput');
    const resetButton = document.getElementById('resetButton');
    const filterSelect = document.getElementById('filter');
    const searchInput = document.getElementById('search');
    const downloadBtn = document.getElementById('downloadButton');
    const loadingOverlay = document.getElementById('loadingOverlay');

    resetButton.addEventListener('click', () => {
      fileInput.value = '';
      filterSelect.value = 'all';
      searchInput.value = '';
      originalData = [];
      transformedData = [];
      headersOrder = [];
      document.getElementById('tableContainer').innerHTML = '';
      downloadBtn.disabled = true;
    });

    fileInput.addEventListener('change', handleFile);
    filterSelect.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
    downloadBtn.addEventListener('click', downloadExcel);

    function showLoading() { loadingOverlay.style.display = 'flex'; }
    function hideLoading() { loadingOverlay.style.display = 'none'; }

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      originalFileName = file.name.replace(/\.[^/.]+$/, '');
      showLoading(); downloadBtn.disabled = true;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        const headers = rows[1] || [];
        metaRow1 = headers;
        metaRow3 = rows[3] || [];

        originalData = XLSX.utils.sheet_to_json(sheet, {
          defval: '',
          header: headers,
          range: 5
        });

        headersOrder = ['ìƒí’ˆë²ˆí˜¸', 'íŒë§¤ì ìƒí’ˆì½”ë“œ', 'ìƒí’ˆëª…', ...axisNames, 'ì˜µì…˜ ì¬ê³ ìˆ˜ëŸ‰', 'ì¶”ê°€ìƒí’ˆëª…', 'ì¶”ê°€ìƒí’ˆê°’', 'ì¶”ê°€ìƒí’ˆ ì¬ê³ ìˆ˜ëŸ‰'];
        transformData(); applyFilters(); downloadBtn.disabled = false; hideLoading();
      };
      reader.readAsArrayBuffer(file);
    }

    function transformData() {
      transformedData = [];
      originalData.forEach(row => {
        const base = {
          'ìƒí’ˆë²ˆí˜¸': row['ìƒí’ˆë²ˆí˜¸'] || '',
          'íŒë§¤ì ìƒí’ˆì½”ë“œ': row['íŒë§¤ì ìƒí’ˆì½”ë“œ'] || '',
          'ìƒí’ˆëª…': row['ìƒí’ˆëª…'] || ''
        };
        const vals = (row['ì˜µì…˜ê°’'] || '').split(/\r?\n/);
        const stocks = (row['ì˜µì…˜ ì¬ê³ ìˆ˜ëŸ‰'] || '').split(/\r?\n/);
        const len = Math.max(vals.length, stocks.length);
        for (let i = 0; i < len; i++) {
          const parts = (vals[i] || '').split(',').map(v => v.trim());
          const entry = { ...base, 'ì˜µì…˜ ì¬ê³ ìˆ˜ëŸ‰': stocks[i]?.trim() || '' };
          axisNames.forEach((n, idx) => entry[n] = parts[idx] || '');
          entry['ì¶”ê°€ìƒí’ˆëª…'] = ''; entry['ì¶”ê°€ìƒí’ˆê°’'] = ''; entry['ì¶”ê°€ìƒí’ˆ ì¬ê³ ìˆ˜ëŸ‰'] = '';
          transformedData.push(entry);
        }
        const aVals = (row['ì¶”ê°€ìƒí’ˆê°’'] || '').split(',').map(v => v.trim());
        const aStocks = (row['ì¶”ê°€ìƒí’ˆ ì¬ê³ ìˆ˜ëŸ‰'] || '').split(',').map(v => v.trim());
        const alen = Math.max(aVals.length, aStocks.length);
        for (let i = 0; i < alen; i++) {
          const entry = { ...base, 'ì˜µì…˜ ì¬ê³ ìˆ˜ëŸ‰': '' };
          axisNames.forEach(n => entry[n] = '');
          entry['ì¶”ê°€ìƒí’ˆëª…'] = row['ì¶”ê°€ìƒí’ˆëª…'] || '';
          entry['ì¶”ê°€ìƒí’ˆê°’'] = aVals[i] || '';
          entry['ì¶”ê°€ìƒí’ˆ ì¬ê³ ìˆ˜ëŸ‰'] = aStocks[i] || '';
          transformedData.push(entry);
        }
      });
    }

    function applyFilters() {
      const filtered = getFilteredData();
      renderTable(filtered);
    }

    function getFilteredData() {
      const mode = filterSelect.value;
      const term = searchInput.value.trim().toLowerCase();
      return transformedData.filter(r => {
        const hasOpt = axisNames.some(n => r[n]);
        if (!hasOpt && !r['ì¶”ê°€ìƒí’ˆê°’']) return false;
        const stock = hasOpt ? Number(r['ì˜µì…˜ ì¬ê³ ìˆ˜ëŸ‰'] || 0) : Number(r['ì¶”ê°€ìƒí’ˆ ì¬ê³ ìˆ˜ëŸ‰'] || 0);
        if (mode === 'inStock' && stock <= 0) return false;
        if (mode === 'soldOut' && stock !== 0) return false;
        return term ? headersOrder.some(h => r[h]?.toString().toLowerCase().includes(term)) : true;
      });
    }

    function renderTable(data) {
      const container = document.getElementById('tableContainer');
      if (!data.length) {
        container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      let html = '<table><thead><tr>' + headersOrder.map(h =>
        `<th${h === 'ì¶”ê°€ìƒí’ˆëª…' ? ' class="col-add-name"' : ''}>${h}</th>`
      ).join('') + '</tr></thead><tbody>';
      html += data.map(r => '<tr>' + headersOrder.map(h =>
        `<td${h === 'ì¶”ê°€ìƒí’ˆëª…' ? ' class="col-add-name"' : ''}>${r[h] || ''}</td>`
      ).join('') + '</tr>').join('');
      html += '</tbody></table>';
      container.innerHTML = html;
    }

function downloadExcel() {
  showLoading();
  const filtered = getFilteredData();
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([]);

  const jsonData = filtered.map(r => {
    const o = {};
    headersOrder.forEach(h => o[h] = r[h] || '');
    return o;
  });

  const activeHeaders = headersOrder.filter(h => jsonData.some(r => r[h]));
  
  // ğŸ‘‰ metaRow1/metaRow3 ì œê±°í•˜ê³  ì‹¤ì œ í‘œì‹œëœ ì—´ë§Œ í¬í•¨
  XLSX.utils.sheet_add_aoa(ws, [activeHeaders], { origin: 'A1' });
  XLSX.utils.sheet_add_json(ws, jsonData, { skipHeader: true, origin: 'A2' });

  ws['!cols'] = activeHeaders.map(h => ({
    wch: Math.max(h.length, ...jsonData.map(r => (r[h] || '').toString().length)) + 2
  }));

  const suffixMap = { all: 'ì „ì²´ë³´ê¸°', inStock: 'ì¬ê³ ìˆìŒ', soldOut: 'í’ˆì ˆë³´ê¸°' };
  const suffix = suffixMap[filterSelect.value] || '';
  const fileName = `${originalFileName}${suffix ? '-' + suffix : ''}.xlsx`;
  XLSX.utils.book_append_sheet(wb, ws, 'ë¶„ë¦¬ëœì˜µì…˜');
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  saveAs(new Blob([wbout], { type: 'application/octet-stream' }), fileName);
  hideLoading();
}

  </script>
</body>
</html>
